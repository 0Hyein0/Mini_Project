<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.stock.model.IStockListDAO">

	<select id="stockList" resultType="com.stock.model.StockListDTO">
	SELECT P.PR_NO AS PR_NO, P.PR_CODE AS PR_CODE, P.PR_NAME AS PR_NAME, TO_CHAR(P.PR_DATE, 'YYYY-MM-DD') AS PR_DATE, 
       NVL(SUM(DISTINCT_IN.IN_QUANTITY), 0) AS TOTAL_IN,
       NVL(SUM(DISTINCT_OUT.OUT_QUANTITY), 0) AS TOTAL_OUT,
       W.WA_NAME AS WA_NAME
	FROM PRODUCTS P
	JOIN WAREHOUSES W ON EXISTS (
	    SELECT 1
	    FROM IN_DATA IN_D
	    WHERE IN_D.PR_NO = P.PR_NO AND IN_D.WA_CODE = W.WA_CODE
	    UNION
	    SELECT 1
	    FROM OUT_DATA OUT_D
	    WHERE OUT_D.PR_NO = P.PR_NO AND OUT_D.WA_CODE = W.WA_CODE
	)
	LEFT JOIN (
	    SELECT PR_NO, WA_CODE, SUM(IN_QUANTITY) AS IN_QUANTITY
	    FROM IN_DATA
	    GROUP BY PR_NO, WA_CODE
	) DISTINCT_IN ON P.PR_NO = DISTINCT_IN.PR_NO AND W.WA_CODE = DISTINCT_IN.WA_CODE
	LEFT JOIN (
	    SELECT PR_NO, WA_CODE, SUM(OUT_QUANTITY) AS OUT_QUANTITY
	    FROM OUT_DATA
	    GROUP BY PR_NO, WA_CODE
	) DISTINCT_OUT ON P.PR_NO = DISTINCT_OUT.PR_NO AND W.WA_CODE = DISTINCT_OUT.WA_CODE
	WHERE W.AC_CODE = #{ac_code}
	GROUP BY P.PR_NO, P.PR_CODE, P.PR_NAME,P.PR_DATE, W.WA_CODE, W.WA_NAME
	</select>
	
	<select id="inList" resultType="com.stock.model.StockListDTO">
		SELECT I.IN_CODE AS IN_CODE, I.IN_QUANTITY AS IN_QUANTITY, TO_CHAR(I.IN_DATE, 'YYYY-MM-DD') AS IN_DATE, I.IN_DESCRIPTION AS IN_DESCRIPTION
    	, W.WA_NAME AS WA_NAME, P.PR_NO AS PR_NO, P.PR_CODE AS PR_CODE, P.PR_NAME AS PR_NAME, TO_CHAR(P.PR_DATE, 'YYYY-MM-DD')AS PR_DATE, P.PR_DESCRIPTION AS PR_DESCRIPTION
		FROM IN_DATA I JOIN PRODUCTS P
		ON I.PR_NO = P.PR_NO
		JOIN WAREHOUSES W
		ON I.WA_CODE = W.WA_CODE
		WHERE W.AC_CODE = #{ac_code}
		ORDER BY I.IN_CODE DESC
	</select>


</mapper>