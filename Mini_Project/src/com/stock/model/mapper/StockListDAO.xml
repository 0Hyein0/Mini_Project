<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
 PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.stock.model.IStockListDAO">

	<select id="stockList" resultType="com.stock.model.StockListDTO">
		<![CDATA[
			SELECT P.PR_CODE AS PR_CODE, P.PR_NAME AS PR_NAME, 
		       NVL(SUM(DISTINCT_IN.IN_QUANTITY), 0) AS TOTAL_IN,
		       NVL(SUM(DISTINCT_OUT.OUT_QUANTITY), 0) AS TOTAL_OUT,
		       W.WA_NAME AS WA_NAME
			FROM PRODUCTS P
			JOIN WAREHOUSES W ON EXISTS (
			    SELECT 1
			    FROM IN_DATA I
			    WHERE I.PR_CODE = P.PR_CODE AND I.WA_CODE = W.WA_CODE
			    AND I.IN_DATE <= SYSDATE
			    UNION
			    SELECT 1
			    FROM OUT_DATA O
			    WHERE O.PR_CODE = P.PR_CODE AND O.WA_CODE = W.WA_CODE
			    AND O.OUT_DATE <= SYSDATE
			)
			LEFT JOIN (
			    SELECT PR_CODE, WA_CODE, SUM(IN_QUANTITY) AS IN_QUANTITY
			    FROM IN_DATA
			    WHERE IN_DATE <= SYSDATE
			    GROUP BY PR_CODE, WA_CODE
			) DISTINCT_IN ON P.PR_CODE = DISTINCT_IN.PR_CODE AND W.WA_CODE = DISTINCT_IN.WA_CODE
			LEFT JOIN (
			    SELECT PR_CODE, WA_CODE, SUM(OUT_QUANTITY) AS OUT_QUANTITY
			    FROM OUT_DATA
			    WHERE OUT_DATE <= SYSDATE
			    GROUP BY PR_CODE, WA_CODE
			) DISTINCT_OUT ON P.PR_CODE = DISTINCT_OUT.PR_CODE AND W.WA_CODE = DISTINCT_OUT.WA_CODE
			WHERE W.AC_CODE = #{ac_code}
			GROUP BY P.PR_CODE, P.PR_NAME, W.WA_CODE, W.WA_NAME
		]]>
	</select>
	
	
	<select id="inList" resultType="com.stock.model.StockListDTO">
		<![CDATA[
			SELECT I.IN_CODE AS IN_CODE, I.IN_QUANTITY AS IN_QUANTITY, TO_CHAR(I.IN_DATE, 'YYYY-MM-DD') AS IN_DATE, I.IN_DESCRIPTION AS IN_DESCRIPTION
	    	, W.WA_NAME AS WA_NAME, P.PR_CODE AS PR_CODE, P.PR_NAME AS PR_NAME, P.PR_DESCRIPTION AS PR_DESCRIPTION
			FROM IN_DATA I JOIN PRODUCTS P
			ON I.PR_CODE = P.PR_CODE
			JOIN WAREHOUSES W
			ON I.WA_CODE = W.WA_CODE
			WHERE W.AC_CODE = #{ac_code}
			AND I.IN_DATE <= SYSDATE
			ORDER BY I.IN_DATE DESC
		]]>
	</select>
	
	<select id="outList" resultType="com.stock.model.StockListDTO">
		<![CDATA[
			SELECT O.OUT_CODE AS OUT_CODE, O.OUT_QUANTITY AS OUT_QUANTITY, TO_CHAR(O.OUT_DATE, 'YYYY-MM-DD') AS OUT_DATE, O.OUT_DESCRIPTION AS OUT_DESCRIPTION
	    	, W.WA_NAME AS WA_NAME, P.PR_CODE AS PR_CODE, P.PR_NAME AS PR_NAME, P.PR_DESCRIPTION AS PR_DESCRIPTION
			FROM OUT_DATA O JOIN PRODUCTS P
			ON O.PR_CODE = P.PR_CODE
			JOIN WAREHOUSES W
			ON O.WA_CODE = W.WA_CODE
			WHERE W.AC_CODE = #{ac_code}
			AND O.OUT_DATE <= SYSDATE
			ORDER BY O.OUT_DATE DESC
		]]>
	</select>


</mapper>
